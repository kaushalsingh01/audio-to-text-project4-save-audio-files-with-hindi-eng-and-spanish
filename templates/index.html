<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Multilingual Transcription & Chat</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Transcription Panel -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìù Live Transcription</div>
                <div id="online-status" class="status offline">Offline</div>
            </div>
            
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('transcripts')">Transcripts</div>
                <div class="tab" onclick="switchTab('translations')">Translations</div>
            </div>
            
            <div id="transcripts-tab" class="tab-content active">
                <table id="transcript-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Language</th>
                            <th>Text</th>
                            <th>Audio</th>
                        </tr>
                    </thead>
                    <tbody id="transcript-body"></tbody>
                </table>
                
                <div class="controls">
                    <select id="language-filter">
                        <option value="all">All Languages</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="hi">Hindi</option>
                    </select>
                    <button onclick="loadTranscripts()">Refresh</button>
                    <button onclick="downloadTxt()">Download TXT</button>
                    <button onclick="downloadCsv()">Download CSV</button>
                    <button id="sync-button" onclick="syncUnvalidated()" style="display:none;">Sync Words</button>
                </div>
                
                <div id="sync-info" class="sync-info" style="display:none;">
                    <span id="sync-message"></span>
                </div>
            </div>
            
            <div id="translations-tab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Original Word</th>
                            <th>Language</th>
                            <th>English</th>
                            <th>Spanish</th>
                            <th>Hindi</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="translations-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Chat Panel -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üí¨ Multilingual Chat</div>
                <div class="language-selector">
                    <div class="language-flag flag-en"></div>
                    <div class="language-flag flag-es"></div>
                    <div class="language-flag flag-hi"></div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot">
                        <div class="message-header">
                            <span>Bot</span>
                            <span>Just now</span>
                        </div>
                        <div class="message-text">Hello! I can translate between English, Spanish, and Hindi. How can I help you?</div>
                    </div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Type your message here...">
                    <button onclick="sendMessage()">‚û§</button>
                    <!-- <button onclick="startVoiceInput()">üé§</button> -->
                </div>
                
                <div class="controls">
                    <select id="input-language">
                        <option value="auto">Auto Detect</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="hi">Hindi</option>
                    </select>
                    <button onclick="clearChat()">Clear Chat</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentTab = 'transcripts';
        let sessionId = 'session_' + Date.now();
        let isOnline = navigator.onLine;
        
        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusElement = document.getElementById('online-status');
            const syncButton = document.getElementById('sync-button');
            const syncInfo = document.getElementById('sync-info');
            
            if (isOnline) {
                statusElement.textContent = 'Online';
                statusElement.className = 'status online';
                syncButton.style.display = 'none';
                syncInfo.style.display = 'none';
            } else {
                statusElement.textContent = 'Offline';
                statusElement.className = 'status offline';
                syncButton.style.display = 'inline-block';
                syncInfo.style.display = 'flex';
                document.getElementById('sync-message').textContent = 
                    'Words will be saved locally and synced when online';
            }
        }
        
        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab UI
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load data for the tab
            if (tabName === 'transcripts') {
                loadTranscripts();
            } else if (tabName === 'translations') {
                loadTranslations();
            }
        }
        
        // Load transcripts
        async function loadTranslations() {
                const response = await fetch('/api/translations?validated=1');
                const data = await response.json();

                const tbody = document.getElementById('translations-body');
                tbody.innerHTML = '';

                data.translations.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td><strong>${item.original_word}</strong></td>
            <td>${item.detected_language.toUpperCase()}</td>
            <td>
                ${item.translation_en || '‚Äî'}
                ${item.meaning_en ? `<br><small class="meaning">${item.meaning_en}</small>` : ''}
            </td>
            <td>
                ${item.translation_es || '‚Äî'}
                ${item.meaning_es ? `<br><small class="meaning">${item.meaning_es}</small>` : ''}
            </td>
            <td>
                ${item.translation_hi || '‚Äî'}
                ${item.meaning_hi ? `<br><small class="meaning">${item.meaning_hi}</small>` : ''}
            </td>
            <td>${item.part_of_speech || '‚Äî'}</td>
            <td>
                <span style="padding: 3px 8px; border-radius: 12px; 
                             background: ${item.is_validated ? '#d4edda' : '#fff3cd'}; 
                             color: ${item.is_validated ? '#155724' : '#856404'}; 
                             font-size: 12px;">
                    ${item.is_validated ? 'Validated' : 'Pending'}
                </span>
            </td>
        `;
                    tbody.appendChild(row);
                });
            }
        
        // Load translations
        async function loadTranslations() {
            const response = await fetch('/api/translations?validated=1');
            const data = await response.json();
            
            const tbody = document.getElementById('translations-body');
            tbody.innerHTML = '';
            
            data.translations.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.original_word}</strong></td>
                    <td>${item.detected_language.toUpperCase()}</td>
                    <td>${item.translation_en || '‚Äî'}</td>
                    <td>${item.translation_es || '‚Äî'}</td>
                    <td>${item.translation_hi || '‚Äî'}</td>
                    <td>
                        <span style="padding: 3px 8px; border-radius: 12px; 
                                     background: ${item.is_validated ? '#d4edda' : '#fff3cd'}; 
                                     color: ${item.is_validated ? '#155724' : '#856404'}; 
                                     font-size: 12px;">
                            ${item.is_validated ? 'Validated' : 'Pending'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessageToChat(message, 'user');
            input.value = '';
            
            try {
                const response = await fetch('/api/chat/text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                // Add bot response to chat
                addBotResponseToChat(data);
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessageToChat('Sorry, an error occurred. Please try again.', 'bot');
            }
        }
        
        // Add message to chat
        function addMessageToChat(text, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span>${sender === 'user' ? 'You' : 'Bot'}</span>
                    <span>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="message-text">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add bot response to chat with translations
        function addBotResponseToChat(responseData) {
                const chatMessages = document.getElementById('chat-messages');
                const botResponse = responseData.bot_response;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';

                // Format translations
                let translationsHtml = '';
                if (botResponse.translations) {
                    translationsHtml = `
            <div class="message-translations">
                <strong>Translations:</strong><br>
                ${botResponse.translations.en ? `üá∫üá∏ ${botResponse.translations.en}<br>` : ''}
                ${botResponse.translations.es ? `üá™üá∏ ${botResponse.translations.es}<br>` : ''}
                ${botResponse.translations.hi ? `üáÆüá≥ ${botResponse.translations.hi}` : ''}
            </div>
        `;
                }

                // Add meanings if available
                let meaningsHtml = '';
                if (botResponse.meanings) {
                    meaningsHtml = `
            <div class="message-meanings">
                <strong>Meanings:</strong><br>
                ${botResponse.meanings.en ? `üá∫üá∏ ${botResponse.meanings.en}<br>` : ''}
                ${botResponse.meanings.es ? `üá™üá∏ ${botResponse.meanings.es}<br>` : ''}
                ${botResponse.meanings.hi ? `üáÆüá≥ ${botResponse.meanings.hi}` : ''}
            </div>
        `;
                }

                // Add part of speech if available
                let posHtml = '';
                if (botResponse.part_of_speech) {
                    posHtml = `
            <div class="message-pos">
                <strong>Part of Speech:</strong> ${botResponse.part_of_speech.en || ''}
            </div>
        `;
                }

                messageDiv.innerHTML = `
        <div class="message-header">
            <span>Bot</span>
            <span>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        <div class="message-text">${botResponse.text}</div>
        ${translationsHtml}
        ${meaningsHtml}
        ${posHtml}
    `;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        
        // Start voice input
        // async function startVoiceInput() {
        //     try {
        //         const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        //         const mediaRecorder = new MediaRecorder(stream);
        //         const audioChunks = [];
                
        //         mediaRecorder.addEventListener("dataavailable", event => {
        //             audioChunks.push(event.data);
        //         });
                
        //         mediaRecorder.addEventListener("stop", async () => {
        //             const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
        //             // Show recording indicator
        //             addMessageToChat("Recording...", 'user');
                    
        //             // Send to server
        //             const formData = new FormData();
        //             formData.append('audio', audioBlob, 'recording.wav');
        //             formData.append('session_id', sessionId);
                    
        //             const response = await fetch('/api/chat/audio', {
        //                 method: 'POST',
        //                 body: formData
        //             });
                    
        //             const data = await response.json();
                    
        //             // Update chat with transcribed message and response
        //             addMessageToChat(data.user_input.text, 'user');
        //             addBotResponseToChat(data);
                    
        //             // Stop all tracks
        //             stream.getTracks().forEach(track => track.stop());
        //         });
                
        //         // Start recording
        //         mediaRecorder.start();
                
        //         // Stop after 5 seconds
        //         setTimeout(() => {
        //             mediaRecorder.stop();
        //         }, 5000);
                
        //     } catch (error) {
        //         console.error('Voice input error:', error);
        //         addMessageToChat('Voice input failed. Please check microphone permissions.', 'bot');
        //     }
        // }
        
        // Sync unvalidated words
        async function syncUnvalidated() {
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST'
                });
                
                const data = await response.json();
                alert(`Synced ${data.processed_count} words!`);
                loadTranslations();
                
            } catch (error) {
                console.error('Sync error:', error);
                alert('Sync failed. Please check internet connection.');
            }
        }
        
        // Download functions
        async function downloadTxt() {
            window.location.href = '/download/txt';
        }
        
        async function downloadCsv() {
            window.location.href = '/download/csv';
        }
        
        // Clear chat
        function clearChat() {
            document.getElementById('chat-messages').innerHTML = `
                <div class="message bot">
                    <div class="message-header">
                        <span>Bot</span>
                        <span>Just now</span>
                    </div>
                    <div class="message-text">Hello! I can translate between English, Spanish, and Hindi. How can I help you?</div>
                </div>
            `;
        }
        
        // Enter key to send message
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function checkTransciberStatus(){
            try {
                const response = await fetch('/api/transcriber/stats');
                const data = await response.json();
                // Add to your status display
                const statusDiv = document.getElementById('transcriber-status');
                if (statusDiv && data.stats) {
                    statusDiv.innerHTML = `
                <div class="transcriber-status">
                    <strong>üé§ Transcriber:</strong><br>
                    Unvalidated: ${data.stats.unvalidated || 0}<br>
                    Validated: ${data.stats.validated || 0}<br>
                    Status: ${data.transcriber_running ? '‚úÖ Running' : '‚ùå Stopped'}
                </div>
            `;
                }
            } catch (error) {
                console.error('Transcriber status check failed:', error);
            }
        }

        setInterval(checkTransciberStatus, 10000);
        checkTransciberStatus();
        
        // Online/offline event listeners
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initialize
        updateOnlineStatus();
        loadTranscripts();
        
        // Auto-refresh transcripts every 10 seconds
        setInterval(loadTranscripts, 10000);
    </script>
</body>
</html>